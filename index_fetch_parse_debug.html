<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OpenLayers KML Map</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css" />
  <style>
    :root{--panel-w:320px;--border:rgba(0,0,0,.15);--bg:rgba(255,255,255,.92);--shadow:0 8px 24px rgba(0,0,0,.18);--radius:10px;--font:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    html,body{height:100%;margin:0;padding:0;font-family:var(--font);}
    #app{height:100%;width:100%;display:grid;grid-template-columns:var(--panel-w) 1fr;}
    #map{width:100%;height:100%;}
    #panel{background:var(--bg);border-right:1px solid var(--border);overflow:hidden;display:grid;grid-template-rows:auto auto 1fr auto;}
    #panelHeader{padding:12px 12px 10px;border-bottom:1px solid var(--border);}
    #panelHeader h1{margin:0 0 8px;font-size:15px;font-weight:800;}
    #panelHeader .sub{margin:0;font-size:12px;opacity:.75;line-height:1.3;}
    #controls{padding:10px 12px;border-bottom:1px solid var(--border);display:grid;gap:8px;}
    #search{width:100%;box-sizing:border-box;padding:9px 10px;border-radius:10px;border:1px solid var(--border);outline:none;font-size:13px;background:rgba(255,255,255,.95);}
    #toggles{display:flex;gap:8px;align-items:center;flex-wrap:wrap;font-size:12px;opacity:.9;}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.85);cursor:pointer;user-select:none;}
    .pill input{margin:0;}
    #featureList{overflow:auto;padding:0;margin:0;list-style:none;}
    .item{padding:10px 12px;border-bottom:1px solid rgba(0,0,0,.06);cursor:pointer;display:grid;gap:4px;}
    .item:hover{background:rgba(0,0,0,.035);}
    .item .name{font-size:13px;font-weight:650;}
    .item .meta{font-size:12px;opacity:.75;}
    #panelFooter{padding:10px 12px;border-top:1px solid var(--border);font-size:12px;opacity:.75;display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap;}
    @media (max-width:820px){
      #app{grid-template-columns:1fr;}
      #panel{position:absolute;z-index:10;width:min(92vw,var(--panel-w));height:calc(100% - 20px);left:10px;top:10px;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);transform:translateX(calc(-100% - 16px));transition:transform .25s ease;}
      #panel.open{transform:translateX(0);}
      #panelToggleBtn{position:absolute;z-index:11;left:10px;top:10px;background:var(--bg);border:1px solid var(--border);border-radius:999px;box-shadow:var(--shadow);padding:8px 10px;font-size:13px;cursor:pointer;}
    }
    .ol-popup{position:absolute;background:#fff;padding:12px 12px 10px;border-radius:10px;border:1px solid rgba(0,0,0,.25);bottom:12px;left:-50px;min-width:240px;max-width:min(460px,calc(100vw - 24px));box-shadow:var(--shadow);font-size:14px;line-height:1.35;}
    .ol-popup-closer{text-decoration:none;position:absolute;top:6px;right:8px;font-size:18px;color:rgba(0,0,0,.55);}
    .ol-popup-closer:hover{color:rgba(0,0,0,.85);}
    .popup-title{font-weight:800;margin:0 70px 6px 0;font-size:15px;}
    .popup-nav{display:flex;gap:8px;align-items:center;margin:8px 0 0;font-size:12px;opacity:.9;}
    .btn{border:1px solid var(--border);background:rgba(255,255,255,.9);padding:6px 10px;border-radius:999px;cursor:pointer;user-select:none;}
    .btn:disabled{opacity:.45;cursor:default;}
    .hint{position:absolute;top:10px;right:10px;background:var(--bg);border:1px solid var(--border);padding:8px 10px;border-radius:10px;font-size:12px;box-shadow:var(--shadow);}
    .err{position:absolute;left:10px;bottom:10px;background:rgba(255,245,245,.95);border:1px solid rgba(180,0,0,.25);color:rgba(120,0,0,.9);padding:10px 12px;border-radius:10px;font-size:12px;box-shadow:var(--shadow);max-width:min(700px,calc(100vw - 24px));display:none;white-space:pre-wrap;}
  </style>
</head>
<body>
  <div id="panelToggleBtn" style="display:none;">☰ List</div>

  <div id="app">
    <aside id="panel" class="open">
      <div id="panelHeader">
        <h1>Feature list</h1>
        <p class="sub">Search and click a feature to zoom to it. Click on the map for a popup.</p>
      </div>

      <div id="controls">
        <input id="search" placeholder="Search features…" autocomplete="off" />
        <div id="toggles">
          <label class="pill" title="Toggle satellite imagery"><input id="satToggle" type="checkbox" />Satellite</label>
          <label class="pill" title="Toggle point clustering"><input id="clusterToggle" type="checkbox" checked />Cluster points</label>
        </div>
      </div>

      <ul id="featureList"></ul>

      <div id="panelFooter">
        <span id="count">Loading KML…</span>
        <span style="white-space:nowrap;">Click tolerance: high</span>
      </div>
    </aside>

    <main style="position:relative;">
      <div id="map"></div>
      <div class="hint">Tip: zoom in if multiple features overlap</div>

      <div id="popup" class="ol-popup" style="display:none;">
        <a href="#" id="popup-closer" class="ol-popup-closer" aria-label="Close popup">×</a>
        <div id="popup-content"></div>
      </div>

      <div id="err" class="err"></div>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
  <script>
    // ----- Helpers
    function escapeHtml(s){return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#039;");}
    function getTitle(p){const t=(p.name??p.Name??p.NAME??'').toString().trim(); return t||'Feature';}
    function getDescription(p){const d=p.description??p.Description??''; if(d===null||d===undefined) return ''; return String(d).trim();}
    function fmtLatLon(coord3857){const ll=ol.proj.toLonLat(coord3857); return `${ll[1].toFixed(6)}, ${ll[0].toFixed(6)}`;}
    function showError(msg){
      const el=document.getElementById('err');
      el.textContent = msg;
      el.style.display='block';
    }

    // ----- Base layers
    const osmLayer=new ol.layer.Tile({source:new ol.source.OSM(), visible:true});
    const esriLayer=new ol.layer.Tile({
      source:new ol.source.XYZ({
        url:'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
        attributions:'Tiles © Esri'
      }),
      visible:false
    });

    // ----- Feature sources
    const pointSource=new ol.source.Vector();
    const otherSource=new ol.source.Vector();
    const clusterSource=new ol.source.Cluster({distance:40, minDistance:12, source: pointSource});

    const otherLayer=new ol.layer.Vector({source: otherSource});
    const clusteredPointLayer=new ol.layer.Vector({
      source:clusterSource, visible:true,
      style:(feature)=>{
        const features=feature.get('features')||[];
        const size=features.length;
        if(size===1){
          const single=features[0];
          return (single.getStyle && single.getStyle()) || null;
        }
        return new ol.style.Style({
          image:new ol.style.Circle({
            radius:Math.min(22, 10 + Math.log(size)*6),
            fill:new ol.style.Fill({color:'rgba(0,0,0,0.55)'}),
            stroke:new ol.style.Stroke({color:'rgba(255,255,255,0.9)', width:2})
          }),
          text:new ol.style.Text({
            text:String(size),
            fill:new ol.style.Fill({color:'white'}),
            font:'bold 12px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif'
          })
        });
      }
    });
    const plainPointLayer=new ol.layer.Vector({source: pointSource, visible:false});

    // ----- Map
    const map=new ol.Map({
      target:'map',
      layers:[osmLayer, esriLayer, otherLayer, clusteredPointLayer, plainPointLayer],
      view:new ol.View({center: ol.proj.fromLonLat([53,32]), zoom:5})
    });

    function fitToAll(){
      const exts=[];
      if(pointSource.getFeatures().length) exts.push(pointSource.getExtent());
      if(otherSource.getFeatures().length) exts.push(otherSource.getExtent());
      if(!exts.length) return;
      let extent=exts[0].slice();
      for(let i=1;i<exts.length;i++) ol.extent.extend(extent, exts[i]);
      map.getView().fit(extent, {padding:[40,40,40,40], maxZoom:14});
    }

    // ----- Robust KML load: fetch text ourselves, then parse
    const KML_URL = 'Iran_new.kml?v=' + Date.now(); // same-origin, cache-busted
    // If you want to use raw.githubusercontent.com instead, replace with:
    // const KML_URL = 'https://raw.githubusercontent.com/AuroraIntel99/Iran-kml-map/main/Iran_new.kml?v=' + Date.now();

    (async ()=>{
      try{
        const res = await fetch(KML_URL, {cache:'no-store'});
        if(!res.ok){
          throw new Error(`HTTP ${res.status} ${res.statusText} when fetching ${KML_URL}`);
        }
        const text = await res.text();

        // Detect Git LFS pointer
        if(text.startsWith('version https://git-lfs.github.com/spec/v1')){
          throw new Error('Your KML is being served as a Git LFS pointer, not real XML. Remove Git LFS for .kml and commit the actual file.');
        }

        const kmlFormat = new ol.format.KML({extractStyles:true});
        const features = kmlFormat.readFeatures(text, {
          featureProjection: map.getView().getProjection()
        });

        if(!features.length){
          throw new Error('KML loaded, but 0 features were parsed. The file may be empty or malformed.');
        }

        // Split point vs non-point
        for(const f of features){
          const g=f.getGeometry(); if(!g) continue;
          const t=g.getType();
          if(t==='Point' || t==='MultiPoint') pointSource.addFeature(f);
          else otherSource.addFeature(f);
        }

        buildSidebar();
        fitToAll();

        document.getElementById('count').textContent =
          `${pointSource.getFeatures().length} point(s), ${otherSource.getFeatures().length} other feature(s)`;
      }catch(err){
        document.getElementById('count').textContent = 'Load error';
        showError(String(err));
        console.error(err);
      }
    })();

    // ----- Sidebar
    const listEl=document.getElementById('featureList');
    const searchEl=document.getElementById('search');
    let allFeatures=[];

    function buildSidebar(){
      allFeatures=[...pointSource.getFeatures(), ...otherSource.getFeatures()];
      allFeatures.sort((a,b)=> getTitle(a.getProperties()).localeCompare(getTitle(b.getProperties())));
      renderList('');
    }
    function renderList(filter){
      const f=filter.trim().toLowerCase();
      listEl.innerHTML='';
      const filtered = f ? allFeatures.filter(feat=>{
        const p=feat.getProperties();
        return getTitle(p).toLowerCase().includes(f) || getDescription(p).toLowerCase().includes(f);
      }) : allFeatures;

      for(const feat of filtered){
        const p=feat.getProperties();
        const name=getTitle(p);
        const desc=getDescription(p);

        const li=document.createElement('li');
        li.className='item';
        li.innerHTML = `<div class="name">${escapeHtml(name)}</div>
          <div class="meta">${escapeHtml(desc ? desc.slice(0,90) : 'No description')}${desc && desc.length>90 ? ' …' : ''}</div>`;
        li.addEventListener('click', ()=>{
          const g=feat.getGeometry(); if(!g) return;
          const extent=g.getExtent();
          map.getView().fit(extent, {padding:[60,60,60,60], maxZoom:15, duration:300});
          const center=ol.extent.getCenter(extent);
          openPopupForFeatures([feat], center, 0);
          closePanelOnMobile();
        });
        listEl.appendChild(li);
      }
      document.getElementById('count').textContent = `${filtered.length} shown / ${allFeatures.length} total`;
    }
    searchEl.addEventListener('input', (e)=> renderList(e.target.value));

    // ----- Popup + overlap nav
    const container=document.getElementById('popup');
    const content=document.getElementById('popup-content');
    const closer=document.getElementById('popup-closer');
    const overlay=new ol.Overlay({element:container, autoPan:{animation:{duration:250}}});
    map.addOverlay(overlay);
    closer.onclick=(evt)=>{evt.preventDefault(); overlay.setPosition(undefined); container.style.display='none'; closer.blur(); return false;};

    function buildPropsTable(props){
      const ignored=new Set(['geometry','styleUrl','style','name','Name','NAME','description','Description']);
      let rows='';
      for(const [k,v] of Object.entries(props)){
        if(ignored.has(k)) continue;
        if(v===null||v===undefined) continue;
        const vs=String(v).trim(); if(!vs) continue;
        rows += `<tr><td style="padding:4px 10px 4px 0;vertical-align:top;opacity:.75;">${escapeHtml(k)}</td>
                 <td style="padding:4px 0;vertical-align:top;">${escapeHtml(vs)}</td></tr>`;
      }
      return rows ? `<table style="border-collapse:collapse;width:100%;">${rows}</table>` : '';
    }

    function openPopupForFeatures(featureList, coordinate, idx){
      const i=Math.max(0, Math.min(idx, featureList.length-1));
      const feat=featureList[i];
      const props=feat.getProperties();
      const title=getTitle(props);
      const desc=getDescription(props);
      const table=buildPropsTable(props);

      const coordLine=`<div style="margin:6px 0 10px;opacity:.75;">Location: ${escapeHtml(fmtLatLon(coordinate))}</div>`;
      const nav = featureList.length>1 ? `
        <div class="popup-nav">
          <button class="btn" id="prevBtn" ${i===0?'disabled':''}>← Prev</button>
          <span>${i+1} / ${featureList.length}</span>
          <button class="btn" id="nextBtn" ${i===featureList.length-1?'disabled':''}>Next →</button>
        </div>` : '';

      content.innerHTML = `
        <div class="popup-title">${escapeHtml(title)}</div>
        ${desc ? `<p style="margin:0 0 8px 0;">${escapeHtml(desc)}</p>` : ''}
        ${coordLine}
        ${table || `<div style="opacity:.75;">No attributes found</div>`}
        ${nav}
      `;

      overlay.setPosition(coordinate);
      container.style.display='block';

      if(featureList.length>1){
        const prevBtn=document.getElementById('prevBtn');
        const nextBtn=document.getElementById('nextBtn');
        if(prevBtn) prevBtn.onclick=()=> openPopupForFeatures(featureList, coordinate, i-1);
        if(nextBtn) nextBtn.onclick=()=> openPopupForFeatures(featureList, coordinate, i+1);
      }
    }

    map.on('singleclick', (evt)=>{
      const hit=[];
      map.forEachFeatureAtPixel(evt.pixel, (feat)=>{
        const clustered=feat.get('features');
        if(Array.isArray(clustered)) clustered.forEach(f=> hit.push(f));
        else hit.push(feat);
      }, {hitTolerance: 12});

      if(!hit.length){overlay.setPosition(undefined); container.style.display='none'; return;}
      const uniq=[]; const seen=new Set();
      for(const f of hit){const id=f.ol_uid; if(seen.has(id)) continue; seen.add(id); uniq.push(f);}
      openPopupForFeatures(uniq, evt.coordinate, 0);
    });

    // ----- Toggles
    document.getElementById('satToggle').addEventListener('change', (e)=>{
      const on=e.target.checked; esriLayer.setVisible(on); osmLayer.setVisible(!on);
    });
    document.getElementById('clusterToggle').addEventListener('change', (e)=>{
      const on=e.target.checked; clusteredPointLayer.setVisible(on); plainPointLayer.setVisible(!on);
    });

    // ----- Mobile panel toggle
    const panel=document.getElementById('panel');
    const panelBtn=document.getElementById('panelToggleBtn');
    function isMobile(){return window.matchMedia('(max-width: 820px)').matches;}
    function syncPanelUI(){ if(isMobile()){panelBtn.style.display='block'; panel.classList.remove('open');} else {panelBtn.style.display='none'; panel.classList.add('open');} }
    function closePanelOnMobile(){ if(isMobile()) panel.classList.remove('open'); }
    panelBtn.addEventListener('click', ()=> panel.classList.toggle('open'));
    window.addEventListener('resize', syncPanelUI);
    syncPanelUI();
  </script>
</body>
</html>
