<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OpenLayers KML Map</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@latest/ol.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; }
    #map { width: 100%; height: 100%; }
    .ol-popup {
      position: absolute;
      background-color: white;
      padding: 12px 12px 10px 12px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,.25);
      bottom: 12px;
      left: -50px;
      min-width: 220px;
      max-width: min(420px, calc(100vw - 24px));
      box-shadow: 0 8px 24px rgba(0,0,0,.18);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 14px;
      line-height: 1.35;
    }
    .ol-popup:after, .ol-popup:before {
      top: 100%;
      border: solid transparent;
      content: " ";
      height: 0;
      width: 0;
      position: absolute;
      pointer-events: none;
    }
    .ol-popup:after {
      border-top-color: white;
      border-width: 10px;
      left: 48px;
      margin-left: -10px;
    }
    .ol-popup:before {
      border-top-color: rgba(0,0,0,.25);
      border-width: 11px;
      left: 48px;
      margin-left: -11px;
    }
    .ol-popup-closer {
      text-decoration: none;
      position: absolute;
      top: 6px;
      right: 8px;
      font-size: 18px;
      color: rgba(0,0,0,.55);
    }
    .ol-popup-closer:hover { color: rgba(0,0,0,.85); }
    .popup-title {
      font-weight: 700;
      margin: 0 22px 6px 0;
      font-size: 15px;
    }
    .popup-body { margin: 0; }
    .hint {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,.9);
      border: 1px solid rgba(0,0,0,.15);
      padding: 8px 10px;
      border-radius: 8px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="hint">Click a feature to see details</div>

  <div id="popup" class="ol-popup" style="display:none;">
    <a href="#" id="popup-closer" class="ol-popup-closer" aria-label="Close popup">Ã—</a>
    <div id="popup-content"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/ol@latest/dist/ol.js"></script>
  <script>
    const baseLayer = new ol.layer.Tile({
      source: new ol.source.OSM()
    });

    // KML layer
    const kmlSource = new ol.source.Vector({
      url: 'Iran_new.kml',
      format: new ol.format.KML({
        extractStyles: true // respect styles inside KML if present
      })
    });

    const kmlLayer = new ol.layer.Vector({
      source: kmlSource
    });

    // Map
    const map = new ol.Map({
      target: 'map',
      layers: [baseLayer, kmlLayer],
      view: new ol.View({
        center: ol.proj.fromLonLat([53, 32]),
        zoom: 5
      })
    });

    // Fit to KML once loaded
    kmlSource.once('change', () => {
      if (kmlSource.getState() === 'ready' && kmlSource.getFeatures().length) {
        map.getView().fit(kmlSource.getExtent(), {
          padding: [40, 40, 40, 40],
          maxZoom: 14
        });
      }
    });

    // Popup overlay
    const container = document.getElementById('popup');
    const content = document.getElementById('popup-content');
    const closer = document.getElementById('popup-closer');

    const overlay = new ol.Overlay({
      element: container,
      autoPan: {
        animation: { duration: 250 }
      }
    });
    map.addOverlay(overlay);

    closer.onclick = function (evt) {
      evt.preventDefault();
      overlay.setPosition(undefined);
      container.style.display = 'none';
      closer.blur();
      return false;
    };

    function escapeHtml(s) {
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    // Build a readable table of properties
    function buildPropsHtml(props) {
      const ignored = new Set(['geometry']);
      const keys = Object.keys(props).filter(k => !ignored.has(k));
      if (!keys.length) return '<p class="popup-body">(No attributes found)</p>';

      // Title preference
      const title =
        (props.name ?? props.Name ?? props.NAME ?? '').toString().trim() ||
        'Feature';

      // If KML has "description", it may already be HTML. We'll escape by default.
      const descRaw = props.description ?? props.Description ?? '';
      const desc = (descRaw === null || descRaw === undefined) ? '' : String(descRaw).trim();

      let rows = '';
      for (const k of keys) {
        if (k.toLowerCase() === 'name' || k.toLowerCase() === 'description') continue;
        const v = props[k];
        if (v === null || v === undefined) continue;
        const vs = String(v).trim();
        if (!vs) continue;
        rows += `<tr><td style="padding:4px 8px 4px 0; vertical-align:top; opacity:.75;">${escapeHtml(k)}</td>` +
                `<td style="padding:4px 0; vertical-align:top;">${escapeHtml(vs)}</td></tr>`;
      }

      const descHtml = desc ? `<p class="popup-body" style="margin:0 0 8px 0;">${escapeHtml(desc)}</p>` : '';
      const tableHtml = rows ? `<table style="border-collapse:collapse; width:100%;">${rows}</table>` : '';
      return `<div class="popup-title">${escapeHtml(title)}</div>${descHtml}${tableHtml}`;
    }

    // Click handler
    map.on('singleclick', (evt) => {
      const feature = map.forEachFeatureAtPixel(evt.pixel, (feat) => feat);
      if (!feature) {
        overlay.setPosition(undefined);
        container.style.display = 'none';
        return;
      }

      const props = feature.getProperties();
      content.innerHTML = buildPropsHtml(props);

      // Position popup: use click coordinate; for points you could also use geometry coord
      overlay.setPosition(evt.coordinate);
      container.style.display = 'block';
    });
  </script>
</body>
</html>
